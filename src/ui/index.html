<html>
<script src="http://threejs.org/build/three.min.js"></script>

<script src="http://threejs.org/examples/js/libs/tween.min.js"></script>

<script src="http://threejs.org/examples/js/libs/stats.min.js"></script>
<script src="https://unpkg.com/three@0.85.0/examples/js/controls/OrbitControls.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="https://threejsfundamentals.org/threejs/resources/threejs/r103/js/loaders/LoaderSupport.js"></script>
<script src="https://threejsfundamentals.org/threejs/resources/threejs/r103/js/loaders/OBJLoader2.js"></script>
<script src="https://threejsfundamentals.org/threejs/resources/threejs/r103/js/loaders/MTLLoader.js"></script>

<head>
	<title>Star Wars RL</title>
	<style>
		body {
			margin: 0;
		}

		canvas {
			width: 100%;
			height: 100%
		}
	</style>
</head>

<body>
	<script>

		init();
		animate();

		// google-chrome --allow-file-access-from-files &

		// Load CSV data
		var url = "data.csv";

		var request = new XMLHttpRequest();
		request.open("GET", url, false);
		request.send(null);

		var csvData = new Array();
		var jsonObject = request.responseText.split(/\r?\n|\r/);
		for (var i = 0; i < jsonObject.length; i++) {
			csvData.push(jsonObject[i].split(','));
		}

		{
    const objLoader = new THREE.OBJLoader2();
    objLoader.loadMtl('../../models/deathstar.mtl', null, (materials) => {
      objLoader.setMaterials(materials);
      objLoader.load('../../models/deathstar.obj', (event) => {
        const root = event.detail.loaderRootNode;
		root.scale.set(0.1,0.1,0.1);
        scene.add(root);
      });
	});
  }

		// Lighting
		var spotLight = new THREE.SpotLight(0xFFFFFF, 2);
		spotLight.position.set(200, 250, 600);
		spotLight.target.position.set(100, -50, 0);
		spotLight.castShadow = true;
		scene.add(spotLight.target);
		scene.add(spotLight);
		spotLight.shadow.mapSize.width = 512; // default
		spotLight.shadow.mapSize.height = 512; // default
		spotLight.shadow.camera.near = 0.5; // default
		spotLight.shadow.camera.far = 15000; // default


		//Sphere 1
		var geometry = new THREE.SphereGeometry(10, 64, 64);
		var material = new THREE.MeshPhongMaterial({ color: 0x0087E6, shininess: 100 });
		var cube = new THREE.Mesh(geometry, material);
		scene.add(cube);

		//Cube 2
		var geometry2 = new THREE.BoxGeometry(30, 5, 5);
		var material2 = new THREE.MeshPhongMaterial({ color: 'red', shininess: 100 });
		var cube2 = new THREE.Mesh(geometry2, material2);
		cube2.position.set(5, 0, 0)

		// Rotation
		cube2.rotation.z = 1;
		cube2.rotation.y = 1;
		scene.add(cube2);

		// Planet
		var geometry = new THREE.SphereGeometry(5, 32,32);
		var material = new THREE.MeshPhongMaterial({ color: 'green', shininess: 100 });
		var planet = new THREE.Mesh(geometry, material);
		planet.position.set(0, 0, 0)
		scene.add(planet);


		var rand_y_max = 100;
		var grid_size = 35;

		// Move planet depending on CSV
		var i = 1;
		$(function () {
			var intervalID = setInterval(function () {

				var rand_y = Math.floor(Math.random() * Math.floor(rand_y_max));
				var final_x = 20*(csvData[i][0]-(grid_size/2))/grid_size;
				var final_z = 20*(csvData[i][1]-(grid_size/2))/grid_size;
				var pred_x = csvData[i][2];
				var pred_z = csvData[i][3];

				planet.position.set(final_x, rand_y, final_z);

				cube2.rotation.set(csvData[i][2],csvData[i][3], 0)
				i+=1;
				if(i >= csvData.length){i=1;}



			}, 500);
			setTimeout(function () {
				clearInterval(intervalID);
			}, 1000000);
		});


		function init() {
			renderer = new THREE.WebGLRenderer({ antialias: true });
			var width = window.innerWidth;
			var height = window.innerHeight;
			renderer.setSize(width, height);
			document.body.appendChild(renderer.domElement);

			scene = new THREE.Scene();
			scene.background = new THREE.Color('white');

			camera = new THREE.PerspectiveCamera(45, width / height, 1, 10000);
			camera.position.x = 0;
			camera.position.y = 10;
			camera.position.z = 100;
			camera.lookAt(new THREE.Vector3(0, 0, 0));

			controls = new THREE.OrbitControls(camera, renderer.domElement);

			var gridXZ = new THREE.GridHelper(100, 10);
			scene.add(gridXZ);

		}

		function animate() {
			controls.update();
			requestAnimationFrame(animate);
			renderer.render(scene, camera);
		}
	</script>
</body>

</html>